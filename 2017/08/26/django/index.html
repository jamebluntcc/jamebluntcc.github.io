<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">

    

    <title>
      Django | ChenCheng&#39;s Blog 
    </title>

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    
      <meta name="author" content="ChenCheng">
    
    

    <meta name="description" content="因为工作的原因，很少接触到 django 。还记得很久很久以前写过仿造一个别人的 blog 项目，那是第一次使用 django 。当时给我的感觉是它太全面了，基本集成好了 web 开发的所有工具。在对 web 开发理解很有限的那会儿，我一边抄着代码，一边理解，算是写好了基础的 blog 雏形。工作上我们不需要写很大，很全的 web app，加上教我的师兄是用 flask 写的项目。所以我也就很自然">
<meta name="keywords" content="django">
<meta property="og:type" content="article">
<meta property="og:title" content="Django | ChenCheng&#39;s Blog">
<meta property="og:url" content="http://yoursite.com/2017/08/26/django/index.html">
<meta property="og:site_name" content="ChenCheng&#39;s Blog">
<meta property="og:description" content="因为工作的原因，很少接触到 django 。还记得很久很久以前写过仿造一个别人的 blog 项目，那是第一次使用 django 。当时给我的感觉是它太全面了，基本集成好了 web 开发的所有工具。在对 web 开发理解很有限的那会儿，我一边抄着代码，一边理解，算是写好了基础的 blog 雏形。工作上我们不需要写很大，很全的 web app，加上教我的师兄是用 flask 写的项目。所以我也就很自然">
<meta property="og:image" content="http://yoursite.com/images/django-init.png">
<meta property="og:image" content="http://yoursite.com/images/django_installed_app.png">
<meta property="og:image" content="http://yoursite.com/images/django_templates.png">
<meta property="og:image" content="http://yoursite.com/images/django_users_app.png">
<meta property="og:updated_time" content="2018-01-28T07:50:29.739Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Django | ChenCheng&#39;s Blog">
<meta name="twitter:description" content="因为工作的原因，很少接触到 django 。还记得很久很久以前写过仿造一个别人的 blog 项目，那是第一次使用 django 。当时给我的感觉是它太全面了，基本集成好了 web 开发的所有工具。在对 web 开发理解很有限的那会儿，我一边抄着代码，一边理解，算是写好了基础的 blog 雏形。工作上我们不需要写很大，很全的 web app，加上教我的师兄是用 flask 写的项目。所以我也就很自然">
<meta name="twitter:image" content="http://yoursite.com/images/django-init.png">
    
    
    
      <link rel="icon" type="image/x-icon" href="/favicon.png">
    
    <link rel="stylesheet" href="/css/uno.css">
    <link rel="stylesheet" href="/css/highlight.css">
    <link rel="stylesheet" href="/css/archive.css">
    <link rel="stylesheet" href="/css/china-social-icon.css">

</head>
<body>

    <span class="mobile btn-mobile-menu">
        <i class="icon icon-list btn-mobile-menu__icon"></i>
        <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

    

<header class="panel-cover panel-cover--collapsed">


  <div class="panel-main">

  
    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">

        

        <h1 class="panel-cover__title panel-title"><a href="/" title="link to homepage">ChenCheng&#39;s Blog</a></h1>
        <hr class="panel-cover__divider" />

        
        <p class="panel-cover__description">
          Teachnology only for better life
        </p>
        <hr class="panel-cover__divider panel-cover__divider--secondary" />
        

        <div class="navigation-wrapper">

          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">

              
                
                <li class="navigation__item"><a href="/#blog" title="" class="blog-button">首页</a></li>
              
                
                <li class="navigation__item"><a href="/about" title="" class="">关于</a></li>
              
                
                <li class="navigation__item"><a href="/archive" title="" class="">归档</a></li>
              

            </ul>
          </nav>

          <!-- ----------------------------
To add a new social icon simply duplicate one of the list items from below
and change the class in the <i> tag to match the desired social network
and then add your link to the <a>. Here is a full list of social network
classes that you can use:

    icon-social-500px
    icon-social-behance
    icon-social-delicious
    icon-social-designer-news
    icon-social-deviant-art
    icon-social-digg
    icon-social-dribbble
    icon-social-facebook
    icon-social-flickr
    icon-social-forrst
    icon-social-foursquare
    icon-social-github
    icon-social-google-plus
    icon-social-hi5
    icon-social-instagram
    icon-social-lastfm
    icon-social-linkedin
    icon-social-medium
    icon-social-myspace
    icon-social-path
    icon-social-pinterest
    icon-social-rdio
    icon-social-reddit
    icon-social-skype
    icon-social-spotify
    icon-social-stack-overflow
    icon-social-steam
    icon-social-stumbleupon
    icon-social-treehouse
    icon-social-tumblr
    icon-social-twitter
    icon-social-vimeo
    icon-social-xbox
    icon-social-yelp
    icon-social-youtube
    icon-social-zerply
    icon-mail

-------------------------------->

<!-- add social info here -->



<nav class="cover-navigation navigation--social">
  <ul class="navigation">

    
      <!-- Github -->
      <li class="navigation__item">
        <a href="https://github.com/jamebluntcc" title="Huno on GitHub">
          <i class='icon icon-social-github'></i>
          <span class="label">GitHub</span>
        </a>
      </li>
    

    <!-- China social icon -->
    <!--
    
      <li class="navigation__item">
        <a href="" title="">
          <i class='icon cs-icon-douban'></i>
          <span class="label">Douban</span>
        </a>
      </li>

      <li class="navigation__item">
        <a href="" title="">
          <i class='icon cs-icon-weibo'></i>
          <span class="label">Weibo</span>
        </a>
      </li>

    -->



  </ul>
</nav>



        </div>

      </div>

    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>


    <div class="content-wrapper">
        <div class="content-wrapper__inner entry">
            

<article class="post-container post-container--single">

  <header class="post-header">
    
    <h1 class="post-title">Django</h1>

    

    <div class="post-meta">
      <time datetime="2017-08-26" class="post-meta__date date">2017-08-26</time> 

      <span class="post-meta__tags tags">

          
            <font class="categories">
            &#8226; 分类:
            <a class="categories-link" href="/categories/full-stack-python/">full stack python</a>
            </font>
          

          
             &#8226; 标签:
            <font class="tags">
              <a class="tags-link" href="/tags/django/">django</a>
            </font>
          

      </span>
    </div>
    
    

  </header>

  <section id="post-content" class="article-content post">
    <p>因为工作的原因，很少接触到 <a href="https://www.djangoproject.com/" target="_blank" rel="noopener">django</a> 。还记得很久很久以前写过仿造一个别人的 blog 项目，那是第一次使用 <code>django</code> 。当时给我的感觉是它太全面了，基本集成好了 web 开发的所有工具。在对 web 开发理解很有限的那会儿，我一边抄着代码，一边理解，算是写好了基础的 blog 雏形。<br>工作上我们不需要写很大，很全的 web app，加上教我的师兄是用 <a href="http://flask.pocoo.org/" target="_blank" rel="noopener">flask</a> 写的项目。所以我也就很自然而然的进了 <code>flask</code> 的坑。在基本会用 <code>flask</code> 后现在回过头来看 <code>django</code> 其实本质都相差无几。<br>所以下面介绍 <code>django</code> 会时不时的与 <code>flask</code> 作对比。</p>
<h3 id="项目的标准化"><a href="#项目的标准化" class="headerlink" title="项目的标准化"></a>项目的标准化</h3><p>第一次使用 <code>django</code> 我想大多数的人都是以下面的代码作为一个基本 <code>django</code> 项目的起始。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">django-admin startproject mysite</span><br></pre></td></tr></table></figure>
<p>当你运行上面那段代码，<code>django</code> 会自动的在本地建立一个叫 mysite 的文件夹，里面的结构基本如下：</p>
<p><img src="/images/django-init.png" alt="Alt text"></p>
<p>这个项目就叫 myblog，以自己的输入为准。正如上面所示，启动以一个叫 <code>manager.py</code> 的文件作为主文件，然后在此项目下，还有一个叫 myblog 的子文件夹，里面其实就是相当于一个主程序入口，包含了全局的配置，<code>url</code> 管理，以及 <code>wsgi</code> 的部署。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manager runserver</span><br></pre></td></tr></table></figure>
<p>不出意外，当运行上面代码后，点开本地浏览器输入 <code>127.0.0.1:8000</code> 就可以看到自己的第一个 <code>django</code> 应用上线了！<br>虽然自己在这个时候任何事情都还没有干，但是 <code>django</code> 已经默认给我做了很多的事情，比如已经搭建了一个拥有强大交互的后台管理。还有用户认证等等，还有很多的其它工作可以在 <code>settings.py</code> 文件中看到：</p>
<p><img src="/images/django_installed_app.png" alt="Alt text"></p>
<p>正如上面看到的，<code>admin</code>,<code>auth</code>等等，都已经在 INSTALLED_APPS 里集成好了。对于主要写 <code>flask</code> 的我来说，这真的是方便多了。但是这里不能直接说 <code>django</code>就比 <code>flask</code> 好用，<code>flask</code> 的定位是”微” 框架，如果你想要和 <code>django</code>一样的后台管理或者是认证系统，要么自己实现，要么使用 <code>flask</code> 的插件实现，很灵活。所以个人觉得从某个角度来说，并不是像很多人说的那样：学 python web 开发最好从 <code>flask</code> 开始，因为 <code>flask</code> 比 <code>django</code>简单的多。如果要实现一个最基本的应用，不考虑工厂函数，蓝本，各个插件的使用学习成本。也许 <code>flask</code> 要比 <code>django</code> 简单，但是如果你要实现的是一个比较规模化和模块化的 web app。不见得 <code>flask</code> 的学习成本要比 <code>django</code>低。</p>
<p>还是回过头来聊聊 <code>django</code>。<code>django</code>给我的最大感觉就是规范性，<code>flask</code> 从不要求项目的布局，而<code>django</code>一上来就规定了项目布局，以及应用布局。对于一个大型应用这点确实比较好。大型应用最重要的一点就是项目的规范，也许这也是 <code>django</code>为什么受广大公司欢迎的原因吧。</p>
<h3 id="django-settings"><a href="#django-settings" class="headerlink" title="django settings"></a>django settings</h3><p>在 <code>django</code>中，<code>settings</code> 保存了基本全部的项目配置信息。就我目前的初步上手来说，比较重要的分别是：</p>
<ul>
<li>ALLOWED_HOSTS  允许 django 使用的 host</li>
<li>INSTALLED_APPS 自己实现的功能都需要注册在这个列表下面</li>
<li>MIDDLEWARE 各种中间件</li>
<li>TEMPLATES 模板路径</li>
<li>DATABASES 数据库配置</li>
</ul>
<p>下面分别说明上面的几个用处：</p>
<p><code>ALLOWED_HOSTS</code> 是设置我们启动 django app 的 host 配置。一般默认的启动是 <code>127.0.0.1:8000</code> ，但是如果你要自己进行修改的话。那就要修改 <code>ALLOWED_HOSTS</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ALLOWED_HOSTS = [<span class="string">'0.0.0.0'</span>]</span><br><span class="line">python manager runserver <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>::<span class="number">9000</span></span><br></pre></td></tr></table></figure>
<p>上面代码就可以监听本地的全部 host ，以及设置 port 为 9000。</p>
<p><code>INSALLED_APPS</code> 是最重要的一个配置，当我们以下面代码写一个叫 app 的应用时：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">django-admin startapp app</span><br></pre></td></tr></table></figure>
<p>就需要在 <code>INSTALLED_APPS</code> 下注册这个应用，在 app 列表下添加 <code>app</code> 这个应用。</p>
<p>其实我一直觉得比较坑的事情就是关于 <code>django</code> 的版本变动，很多时候，因为版本的原因使得有些命令不能正常使用。比如在初始化数据库的时候，前版本是 <code>python manager syncdb</code> 但现在的版本是 <code>python manager makemigrations</code> 所以使用 <code>django</code> 的第一步是检查版本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c <span class="string">'import django;print django.VERSION'</span></span><br></pre></td></tr></table></figure>
<p>马上要说到的 <code>MIDDLEWARE</code> 就是一个比较坑的东西，当我将数据库初始化后，然后在主页面已经看到 django work 的消息时，满怀欢喜的打开 <code>/admin/</code> 时马上报错，说的是 <code>user</code> 没有注册。我一开始还以为是数据库初始化或者是迁移有问题，查了半天才发现是版本的问题，settings 文件中的 <code>MIDDLEWARE</code> 应该改为 <code>MIDDLEWARE_CLASSES</code>。随后可以正常使用 <code>django</code> 的后台管理。说到后台管管理，使用过<code>flask</code> 的同学应该知道，<code>flask</code> 没有自带后台管理，最好的办法就是使用 <a href="http://flask-admin.readthedocs.io/en/latest/" target="_blank" rel="noopener">flask-admin</a>，加上 <a href="https://flask-login.readthedocs.io/en/latest/" target="_blank" rel="noopener">flask-login</a> 实现后台管理。下面说下如何添加数据模型到后台。</p>
<p>首先，自带的后台管理中只有 <code>Users</code>与 <code>Groups</code> ，如果要添加自定义的数据模型就得先定义模型：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">django-admin startapp blog</span><br></pre></td></tr></table></figure>
<p>先建立一个 app，然后在 <code>settings</code> 下进行注册，在 blog 下面的 models.py 中写模型的 <code>ORM</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">blog</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">	name = models.CharField(max_length=<span class="number">50</span>)</span><br><span class="line">	tag = models.CharField(max_length=<span class="number">20</span>)</span><br><span class="line">	create_at = models.DateTimeField(default=datetime.datetime.now())</span><br><span class="line">	...</span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">		<span class="keyword">return</span> self.name</span><br></pre></td></tr></table></figure>
<p>自己定义的模型都是从 <code>django.db</code> 的 <code>models.Model</code> 继承的，而表示数据的类型就是 <code>models.CharField</code>等等。其实大多数 web 框架的 <code>ORM</code> 都是基本相似的，就如著名的 <a href="https://www.sqlalchemy.org/" target="_blank" rel="noopener">sqlalchemy</a> 一样。在 <code>flask</code> 中就是使用更多的是使用 <a href="http://flask-sqlalchemy.pocoo.org/2.3/" target="_blank" rel="noopener">flask-sqlalchemy</a> 基本的代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line">db = SQLalchemy()</span><br><span class="line"></span><br><span class="line">Column = db.Column</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">blog</span><span class="params">(db.Model)</span>:</span></span><br><span class="line">	__tablename__ = <span class="string">'blog'</span></span><br><span class="line">	id = Column(db.Integer, primary_key=<span class="keyword">True</span>)</span><br><span class="line">	name = Column(db.String(<span class="number">50</span>))</span><br><span class="line">	...</span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">		<span class="keyword">return</span> self.name</span><br></pre></td></tr></table></figure>
<p>核心都是将数据库中的表结果转为类。当自己写好数据模型后，就可以 app 中的 <code>admin.py</code> 上进行注册。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> modelA, modelB</span><br><span class="line"></span><br><span class="line">admin.site.register([modelA, modelB])</span><br></pre></td></tr></table></figure>
<p>然后运行起程序，就可以在后台管理中看到刚刚注册的模型。还有关于后台管理的布局与自定义内容可以参考<a href="https://docs.djangoproject.com/en/2.0/ref/contrib/admin/" target="_blank" rel="noopener">这里</a>。</p>
<p><code>TEMPLATES</code> 涉及到基本所有 web 框架都会有的模板引擎，django 可以使用自带的模板语言，当然也可以使用其他的语言。<br>这里我们不会谈模板语言的语法与相关的东西，而是说下在配置文件下的 <code>TEMPLATES</code> ，这个参数是配置模板语言路径的，</p>
<p><img src="/images/django_templates.png" alt="Alt text"></p>
<p>如上面所示，首先我们现在 <code>BASE_DIR</code> 下建一个叫 templates 的文件夹来存放我们的模板，对于不同的 app 可以将在此文件夹下再建 app 子模板文件夹。这里和使用过蓝本后的 <code>flask</code> 模板很类似。</p>
<p><code>DATABASES</code> 是配置数据库的参数，django 默认是使用自带的 <code>sqlite3</code> ，当然我们也可以使用最常用的 mysql， 具体的配置如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line">DATABASES = &#123;</span><br><span class="line">	<span class="string">'prod'</span>: &#123;</span><br><span class="line">	<span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.mysql'</span>,</span><br><span class="line">	<span class="string">'NAME'</span>: os.environ.get(<span class="string">'DB_NAME'</span>),</span><br><span class="line">	<span class="string">'USER'</span>: os.environ.get(<span class="string">'DB_USER'</span>),</span><br><span class="line">	<span class="string">'PASSWORD'</span>: os.environ.get(<span class="string">'DB_PASSWD'</span>),</span><br><span class="line">	<span class="string">'HOST'</span>: <span class="string">'localhost'</span>,</span><br><span class="line">	<span class="string">'PORT'</span>: <span class="string">'3306'</span>,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>DATABASES</code> 是一个字典数据结构，我们新建一个 prod 字典来配置 mysql ，<code>ENGINE</code> 是使用到的数据库类型，可以是默认的 sqlite，也可以是 myql 等等。账号和密码最好是写在环境变量中。</p>
<h3 id="base-auth-app"><a href="#base-auth-app" class="headerlink" title="base auth app"></a>base auth app</h3><p>当我们熟悉了基本的配置后，就可以写应用了。下面借助 django 自带的 <code>auth.contrib.auth</code>应用实现一个用户登录认证为主的简单 app 进而熟悉 django 的基本使用。因为 django 已经给我们默认建立了 <code>users</code> 模型，不再需要我们自己写，当然也可以再继承这个基本的 <code>users</code> 加上自己的一些域。</p>
<p>一个最基本的认证需要包括登录与注册，我们这里就分两步进行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">django-admin startapp users</span><br></pre></td></tr></table></figure>
<p>建立 users app 来实现用户的登录和注册。具体的 app 结构如下：</p>
<p><img src="/images/django_users_app.png" alt="Alt text"></p>
<p>基本的结构与 <code>flask</code> 非常类似，包括一个 views 文件写主要的视图，一个 models 写主要的数据模型，test 测试文件，不一样的是 urls 文件保存视图与 url 的 map，一个 admin 实现数据模型的后台管理。migrations 对数据模型的版本控制与迁移。<br>数据模型已经实现，所以 models 不需要添加任何内容。直接在 views 中写视图函数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render, redirect</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth <span class="keyword">import</span> authenticate, login, logout, forms</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user_login</span><span class="params">(request)</span>:</span></span><br><span class="line">	<span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">		username = request.POST.get(<span class="string">'username'</span>)</span><br><span class="line">		passwd = request.POST.get(<span class="string">'password'</span>)</span><br><span class="line">		user = authenticate(username=username, password=passwd)</span><br><span class="line">		<span class="keyword">if</span> user <span class="keyword">and</span> user.is_actvie:</span><br><span class="line">			login(request, user)</span><br><span class="line">			<span class="keyword">return</span> redirect(<span class="string">'/'</span>)</span><br><span class="line">	<span class="keyword">return</span> render(request, <span class="string">'login.html'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user_logout</span><span class="params">(request)</span>:</span></span><br><span class="line">	logout(request)</span><br><span class="line">	<span class="keyword">return</span> redirect(<span class="string">'/'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user_register</span><span class="params">(request)</span>:</span></span><br><span class="line">	<span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">		form = forms.UserCreationForm(request.POST)</span><br><span class="line">		<span class="keyword">if</span> form.is_valid():</span><br><span class="line">			user = form.save()</span><br><span class="line">			login(request, user)</span><br><span class="line">		<span class="keyword">return</span> redirect(<span class="string">'/'</span>)</span><br><span class="line">	form = forms.UserCreationForm()</span><br><span class="line">	<span class="keyword">return</span> render(request, <span class="string">'register.htm'</span>, context=&#123;<span class="string">'form'</span>: form&#125;)</span><br></pre></td></tr></table></figure>
<p>上面代码借助 <code>django.contrib.auth</code> 实现了一个简单的用户注册，登录与登出功能。这里我会重点与 <code>flask</code> 进行对比。</p>
<ul>
<li>request 参数</li>
</ul>
<p>首先最大的不同就是每一个视图都以 <code>request</code> 作为参数传入到函数中，在 <code>flask</code> 中不会显式将 <code>request</code> 作为参数，因为 <code>flask</code> 通过 <code>Context</code> 即上下文的概念将每一个请求对象设为全局访问，但是每一个请求都是不同上下文对象，这样就巧妙地回避了每一个视图函数传入 <code>request</code> 参数，具体的上下文详情可以参考<a href="http://flask.pocoo.org/docs/0.12/appcontext/" target="_blank" rel="noopener">这里</a> 。在 django 中无论是 views 传入还是最后的 render 方法都是以 <code>request</code> 作为第一个参数。</p>
<ul>
<li>urls 文件</li>
</ul>
<p>在 <code>flask</code> 中不需要单独建立 urls 与 views 的 map 函数，<code>flask</code> 这里又再一次使用了魔法，它使用路由装饰实现了 map。当时第一次学习 <code>flask</code> 就被这种用法吸引到了。<br>在 django 中全部视图函数与 url 的 map 都会在一个叫 urls.py 的文件里，此文件一般如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">	url(<span class="string">r'^login/'</span>, <span class="string">'users.views.user_login'</span>),</span><br><span class="line">	url(<span class="string">r'^logout/'</span>, <span class="string">'users.views.user_logout'</span>),</span><br><span class="line">	...</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p><code>url</code> 函数接受一个 url 正则表达式与视图函数的名字作为参数，将 url 与 views 绑定起来。<br>在主程序里面再用 <code>include</code> 方法，将一个应用的全部 urls 关联到一个总的 url 上。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url, include</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">	url(<span class="string">r'^users/'</span>, include(<span class="string">'users.urls'</span>)),</span><br><span class="line">	...</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<ul>
<li>自带认证</li>
</ul>
<p><code>flask</code> 没有基础的认证机制，最快的方法是使用 <a href="https://flask-login.readthedocs.io/en/latest/" target="_blank" rel="noopener">flask-login</a> 插件，具体实现的过程与 django 的方式基本一致。<br>django 提供 <code>authenticate</code>函数接受从表单输入的 username 与 password 作为参数，返回一个 <code>user</code> 对象，如果此对象存在并且是激活的状态，那就认证成功，随后 <code>login</code> 接受请求头 <code>request</code> 和 <code>user</code> 对象，将此对象保存，实现会话跟踪，在前端模板可以直接使用 <code>user</code> 对象。同理 <code>logout</code> 就是结束会话。下面我会展示在 <code>flask</code> 配合 <code>flask-login</code> 如何实现整个过程的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask_login <span class="keyword">import</span> UserMixin, LoginManager, login_required, login_user, logout_user</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"></span><br><span class="line">db = SQLalchemy(app)</span><br><span class="line">login_manager = LoginManger(app)</span><br><span class="line">Column = db.Column</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(UserMixin, db.Model)</span>:</span></span><br><span class="line">	__tablename__ = <span class="string">'users'</span></span><br><span class="line">	id = Column(db.Integer, primary_key=<span class="keyword">True</span>)</span><br><span class="line">	name = Column(db.String(<span class="number">45</span>))</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@login_manager.user_loader</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_user</span><span class="params">(id)</span>:</span></span><br><span class="line">	<span class="keyword">return</span> User.query.filter_by(id=int(id)).first()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/login', methods=['POST', 'GET'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span>:</span></span><br><span class="line">	form = LoginForm()</span><br><span class="line">	<span class="keyword">if</span> form.validate_on_submit():</span><br><span class="line">		login_user(user)</span><br><span class="line">		...</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/logout')</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logout</span><span class="params">()</span>:</span></span><br><span class="line">	logout_user()</span><br><span class="line">	<span class="keyword">return</span> redirect(<span class="string">'/'</span>)</span><br></pre></td></tr></table></figure>
<p>可以看到 <code>flask-login</code>的认证需要实现几个方法，分别是：</p>
<ul>
<li>is_active : 用户是否激活</li>
<li>is_authenticated：用户是否认证，在使用 login_required 就是按照此工作的</li>
<li>is_anonymous：没有进行认证的用户</li>
<li>get_id：返回用户的唯一 id</li>
</ul>
<p><code>flask-login</code> 中的 <code>UserMixin</code> 已经帮助我们实现了这样几个方法，在模板我们可以直接使用 <code>current_user</code>。<br><code>login_manager.user_loader</code> 装饰一个回调函数，当一个请求发送过来，<code>flask-login</code> 会从 session 中寻找用户的 ID，如果找到就会返回此用户对象，如果没有这个回调函数，<code>flask-login</code> 将无法正常工作。通过对比发现 django 与 <code>flask</code> 的认证机制是很相似的。</p>
<ul>
<li>form</li>
</ul>
<p>django 也有表单对象，大多数都是直接使用的。比如上面使用的 <code>UserCreationForm</code> 直接生成一个用户注册的表单，只是大多数的表单都没有加 css 显得有些简单。在模板上，如果是 POST 方法就一定要有 <a href="https://www.cnblogs.com/hyddd/archive/2009/04/09/1432744.html" target="_blank" rel="noopener">CSRF</a> 保护，实现整个保护也很简单，在表单上添加 <code>crsf_token</code>添加伪随机数就可以了。</p>

  </section>

  <section class="post-comments">

    <!-- 将评论系统（例如Disqus、多说、友言、畅言等）提供的代码片段粘贴在这里 -->
    
</section>


</article>


            <footer class="footer">

    <span class="footer__copyright">&copy; 2016-2018. | 由<a href="https://hexo.io/">Hexo</a>强力驱动 | 主题<a href="https://github.com/someus/huno">Huno</a></span>
    
</footer>

        </div>
    </div>

    <!-- js files -->
    <script src="/js/jquery.min.js"></script>
    <script src="/js/main.js"></script>
    <script src="/js/scale.fix.js"></script>
    

    

    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript"> 
        $(document).ready(function(){
            MathJax.Hub.Config({ 
                tex2jax: {inlineMath: [['[latex]','[/latex]'], ['\\(','\\)']]} 
            });
        });
    </script>


    

    <script src="/js/awesome-toc.min.js"></script>
    <script>
        $(document).ready(function(){
            $.awesome_toc({
                overlay: true,
                contentId: "post-content",
            });
        });
    </script>


    
    
    <!--kill ie6 -->
<!--[if IE 6]>
  <script src="//letskillie6.googlecode.com/svn/trunk/2/zh_CN.js"></script>
<![endif]-->

</body>
</html>
